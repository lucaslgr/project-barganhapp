let pictureCaptured,locationCaptured={latitude:0,longitude:0},videoPlayer=$(".modal.modal-add-post #video-player"),canvasImgCapture=$(".modal.modal-add-post #canvas-img-capture"),btnImgCapture=$(".modal.modal-add-post #btn-img-capture"),imgPickerBox=$(".modal.modal-add-post .image-picker-box"),imgPickerInput=$(".modal.modal-add-post #image-picker"),imgPickerInputLabel=$(".modal.modal-add-post label[for=image-picker]"),btnGeoLocation=$(".modal.modal-add-post #btn-location"),locationLoader=$(".modal.modal-add-post .spinner.spinner-location");function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=(e=>{let t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((a,o)=>{t.call(navigator,e,a,o)}):Promise.reject(new Error("getUserMedia is not implemented!"))})),navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{videoPlayer.srcObject=e,videoPlayer.style.display="block",btnImgCapture.style.display="block"}).catch(e=>{imgPickerBox.style.display="flex"})}function captureImageFromStream2Canvas(e){canvasImgCapture.style.display="block",videoPlayer.style.display="none",e.setAttribute("disabled",!0),e.style.cursor="not-allowed",canvasImgCapture.getContext("2d").drawImage(videoPlayer,0,0,canvasImgCapture.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvasImgCapture.width)),videoPlayer.srcObject.getVideoTracks().forEach(e=>{e.stop()}),pictureCaptured=dataURItoBlob(canvasImgCapture.toDataURL())}function captureImageFromInputFile(e){pictureCaptured=e.files[0],imgPickerInputLabel.innerText="Uma imagem foi enviada!"}function initializeGeoLocation(){"geolocation"in navigator||(btnGeoLocation.style.display="none")}function captureGeoLocation(){if(!("geolocation"in navigator))return;btnGeoLocation.setAttribute("disabled",!0),btnGeoLocation.style.cursor="not-allowed";let e=!0;locationLoader.style.display="inline-block",navigator.geolocation.getCurrentPosition(e=>{btnGeoLocation.setAttribute("disabled",!0),btnGeoLocation.style.cursor="not-allowed",setTimeout(()=>{locationLoader.style.display="none"},500),locationCaptured.latitude=e.coords.latitude,locationCaptured.longitude=e.coords.longitude,console.log("Condinates got by GeoLocation API",e.coords);fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${locationCaptured.longitude},${locationCaptured.latitude}.json?types=address&access_token=pk.eyJ1IjoibHVjYXNsZ3IiLCJhIjoiY2tkYzJrcmVpMTBwMzJ0cGdjYnNnZHc4MSJ9.rpysMhdt4d9iJsKT2boujw`).then(e=>{if(e.ok)return e.json()}).then(e=>{console.log("Fetched adress from MAPBOX API reverse geolocation",e),$("textarea[name=location]").value=e.features[0].place_name,$("textarea[name=location]").focus(),console.log("Response from Google Maps API",e)}).catch(e=>{console.log("Request to Google Maps API failed",e)})},t=>{btnGeoLocation.removeAttribute("disabled"),btnGeoLocation.style.cursor="pointer",locationLoader.style.display="none",e&&(alert("Não foi possível pegar a sua localização...Por favor tente novamente ou digite o seu endereço manualmente."),e=!1),locationCaptured=null},{timeout:7e3})}function showModalAddPost(){initializeMedia(),initializeGeoLocation(),setTimeout(()=>{$(".modal.modal-add-post").classList.toggle("show-modal-add-post"),$("section#posts").classList.toggle("display-none")},10)}function closeModalAddPost(){videoPlayer.srcObject&&(console.log("Stopping the Streamimg..."),videoPlayer.srcObject.getVideoTracks().forEach(e=>{e.stop()})),setTimeout(()=>{$(".modal.modal-add-post").classList.remove("show-modal-add-post"),$("section#posts").classList.remove("display-none")},10),videoPlayer.style.display="none",imgPickerBox.style.display="none",canvasImgCapture.style.display="none";let e=canvasImgCapture.getContext("2d");e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,canvasImgCapture.width,canvasImgCapture.height),e.restore(),btnImgCapture.removeAttribute("disabled"),btnImgCapture.style.cursor="pointer",btnGeoLocation.removeAttribute("disabled"),btnGeoLocation.style.cursor="pointer",imgPickerInput.value="",imgPickerInputLabel.innerText="Selecione uma imagem!",btnGeoLocation.style.display="block",locationLoader.style.display="none"}function clearModalAddPostInputs(){$("input[name=title]").value="",$("textarea[name=location]").value="",$("input[name=price]").value="",$("input[name=whatsapp-contact]").value=""}function sendModalPost(){let e=(new Date).toISOString(),t=$("input[name=title]").value,a=$("textarea[name=location]").value,o=$("input[name=price]").value,n=$("input[name=whatsapp-contact]").value,i=new FormData;i.append("id",e),i.append("title",t),i.append("location",a),i.append("price",o),i.append("whatsapp_contact",n),i.append("image",pictureCaptured,`${e}.png`),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(i=>{writeData("sync-posts",{id:e,title:t,location:a,image:pictureCaptured,price:o,whatsapp_contact:n}).then(()=>{i.sync.register("sync-new-post")}).then(()=>{alert("Anúncio inserido com sucesso!"),clearModalAddPostInputs(),closeModalAddPost()}).catch(e=>{console.log("ERRO",e),alert(`ERRO na sincronização de anúncios : ${e.msg}`),closeModalAddPost()})}):fetch("http://localhost/project-barganhapp/backend-api/public/posts/new",{method:"POST",headers:{"Content-Type":"application/json"},body:i}).then(e=>e.json()).then(e=>{if(e.errors)throw e.errors;alert("Anúncio inserido com sucesso!"),console.log("Inserido um novo post, seu id eh: "+e.data.id_post),fillPosts(),clearModalAddPostInputs(),closeModalAddPost()}).catch(e=>{console.log("ERRO",e),alert(`ERRO ${e.status_code} : ${e.msg}`),closeModalAddPost()})}function createPost(e){let t=document.createElement("div");t.setAttribute("data-id",e.id),t.className="each-post",""===e.image&&(e.image="./src/images/products/product-default.png");let a=document.createElement("img");a.setAttribute("src",e.image),a.setAttribute("alt","imagem do produto");let o=document.createElement("h1");o.className="title",o.innerText=e.title;let n=document.createElement("h4");n.innerText="Localização: ";let i=document.createElement("div");i.className="location",i.innerText=e.location,n.appendChild(i);let s=document.createElement("h4");s.innerText="Data: ";let r=document.createElement("div");r.className="date-created",r.innerText=e.date_created,s.appendChild(r);let l=document.createElement("h4");l.innerText="Preço: ";let d=document.createElement("div");d.className="price",d.innerText=`R$ ${parseFloat(e.price).toFixed(2)}`,l.appendChild(d);let c=document.createElement("h4");c.innerText="Whatsapp: ";let p=document.createElement("div");p.className="whatsapp-contact",p.innerText=e.whatsapp_contact,c.appendChild(p),t.appendChild(a),t.appendChild(o),t.appendChild(n),t.appendChild(s),t.appendChild(l),t.appendChild(c),$("section#posts .section-area").appendChild(t)}function clearAllCards(){$$("section#posts .section-area .each-post").forEach(e=>e.remove())}function fillPosts(){let e=!1;fetch("http://localhost/project-barganhapp/backend-api/public/posts",{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(t=>{if(console.log("Data Cards from web",t),e=!0,t.errors)throw t.errors;clearAllCards(),t.data.map(e=>{createPost(e)})}).catch(e=>{console.log("ERRO",e)}),"indexedDB"in window&&readAllData("posts").then(t=>{if(t.errors)throw t.errors;e||(console.log("Data Cards from indexedDB",t),clearAllCards(),t.map(e=>{createPost(e)}))}).catch(e=>{console.log("ERRO",e)})}function registerServiceWorkerMessagesListener(){"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{console.log("Mensagem recebida do [SW] para main thread",e.data.action),e.data.action&&window[e.data.action]()})}fillPosts(),registerServiceWorkerMessagesListener();